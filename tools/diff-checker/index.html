<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diff Checker | Linus Linhof</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="icon" type="image/svg+xml" href="../../assets/favicon.svg">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>

    <style>
        /* --- View Toggles --- */
        .view-options {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }
        .view-btn {
            background: transparent;
            border: 1px solid var(--border);
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--ink-secondary);
        }
        .view-btn.active {
            background: var(--input-bg);
            color: var(--accent);
            border-color: var(--accent);
            font-weight: bold;
        }

        /* --- Diff Table Styles --- */
        .diff-wrapper {
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--code-bg);
            overflow-x: auto;
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.5;
        }

        table.diff-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Forces equal width columns in side-by-side */
        }

        .diff-table td, .diff-table th {
            padding: 0;
            vertical-align: top;
        }

        /* Line Numbers */
        .diff-num {
            width: 40px;
            min-width: 40px;
            text-align: right;
            padding: 2px 8px;
            color: var(--ink-secondary);
            background: rgba(0,0,0,0.03);
            border-right: 1px solid var(--border);
            user-select: none;
            font-size: 11px;
            opacity: 0.7;
        }

        /* Code Content */
        .diff-code {
            width: 100%;
            padding: 2px 8px;
            white-space: pre-wrap; /* Preserves spaces/tabs but wraps long lines */
            word-break: break-all;
            tab-size: 4;
        }
        
        /* Colors */
        .diff-row-del { background-color: rgba(196, 77, 60, 0.15); } /* Redish */
        .diff-row-add { background-color: rgba(107, 144, 128, 0.25); } /* Greenish */
        .diff-row-neutral { background-color: transparent; }
        .diff-empty { background-color: rgba(0,0,0,0.02); background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.03) 5px, rgba(0,0,0,0.03) 10px); }

        /* Inline Specifics */
        .inline-del { background-color: rgba(196, 77, 60, 0.2); text-decoration: line-through; opacity: 0.8; }
        .inline-add { background-color: rgba(107, 144, 128, 0.3); }

        /* Dark Mode Tweaks */
        body.dark-mode .diff-row-del { background-color: rgba(196, 77, 60, 0.25); }
        body.dark-mode .diff-row-add { background-color: rgba(107, 144, 128, 0.3); }
        body.dark-mode .diff-empty { background-color: rgba(255,255,255,0.03); }
        body.dark-mode .diff-num { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>
    <main>
        <div class="container">
            <div class="tool-header">
                <h1>Diff Checker</h1>
                <p>Compare two blocks of text or code. <br>Preserves indentation and supports Side-by-Side view.</p>
            </div>

            <div class="card">
                
                <div class="split-view">
                    <div>
                        <label for="inputOriginal">Original Text</label>
                        <textarea id="inputOriginal" class="code-editor" placeholder="Paste original text here..." spellcheck="false"></textarea>
                    </div>
                    <div>
                        <label for="inputChanged">Modified Text</label>
                        <textarea id="inputChanged" class="code-editor" placeholder="Paste new text here..." spellcheck="false"></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 1.5rem; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex-grow: 1; min-width: 200px;">
                        <label for="diffMode">Comparison Method</label>
                        <select id="diffMode" style="margin-bottom: 0;">
                            <option value="lines" selected>Line by Line (Best for Code)</option>
                            <option value="words">Word by Word</option>
                            <option value="chars">Character by Character</option>
                            <option value="json">JSON (Formatted)</option>
                        </select>
                    </div>

                    <div style="padding-bottom: 5px;">
                        <label class="toggle-wrapper" style="margin-bottom: 0;">
                            <input type="checkbox" id="ignoreWhitespace" class="toggle-checkbox">
                            <div class="toggle-switch"></div>
                            <span style="font-size: 0.9rem;">Ignore Whitespace</span>
                        </label>
                    </div>
                    
                    <div class="button-group" style="margin-top: 0;">
                        <button class="button" id="compareBtn">Compare</button>
                        <button class="button outline" id="clearBtn">Clear All</button>
                    </div>
                </div>

                <div class="result-box hidden" id="resultBox">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <label style="margin: 0;">Comparison Result</label>
                        
                        <div class="view-options">
                            <button class="view-btn active" id="viewInline" onclick="switchView('inline')">Inline</button>
                            <button class="view-btn" id="viewSide" onclick="switchView('side')">Side-by-Side</button>
                        </div>
                    </div>

                    <div class="diff-wrapper">
                        <table id="diffTable" class="diff-table">
                            <!-- Diff Generated Here -->
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>
    
    <script src="../../assets/js/layout.js"></script>
    
    <script>
        // Elements
        const inputOriginal = document.getElementById('inputOriginal');
        const inputChanged = document.getElementById('inputChanged');
        const compareBtn = document.getElementById('compareBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultBox = document.getElementById('resultBox');
        const diffTable = document.getElementById('diffTable');
        const diffModeSelect = document.getElementById('diffMode');
        const ignoreWhitespace = document.getElementById('ignoreWhitespace');
        
        const viewInlineBtn = document.getElementById('viewInline');
        const viewSideBtn = document.getElementById('viewSide');

        // State
        let currentDiff = null;
        let activeView = 'inline'; // 'inline' or 'side'

        // --- Switch View Logic ---
        window.switchView = function(view) {
            activeView = view;
            if (view === 'inline') {
                viewInlineBtn.classList.add('active');
                viewSideBtn.classList.remove('active');
            } else {
                viewInlineBtn.classList.remove('active');
                viewSideBtn.classList.add('active');
            }
            
            if (currentDiff) renderDiff();
        };

        // --- Compare Logic ---
        compareBtn.addEventListener('click', () => {
            const text1 = inputOriginal.value;
            const text2 = inputChanged.value;
            const mode = diffModeSelect.value;
            const ignoreSpace = ignoreWhitespace.checked;

            if (!text1 && !text2) {
                showToast('Please enter text to compare.', 'error');
                return;
            }

            // Generate Diff Object
            try {
                if (mode === 'json') {
                    const j1 = text1 ? JSON.stringify(JSON.parse(text1), null, 4) : '';
                    const j2 = text2 ? JSON.stringify(JSON.parse(text2), null, 4) : '';
                    currentDiff = Diff.diffLines(j1, j2);
                } 
                else if (mode === 'lines') {
                    currentDiff = ignoreSpace ? Diff.diffTrimmedLines(text1, text2) : Diff.diffLines(text1, text2);
                } 
                else if (mode === 'words') {
                    currentDiff = ignoreSpace ? Diff.diffWords(text1, text2) : Diff.diffWordsWithSpace(text1, text2);
                } 
                else {
                    currentDiff = Diff.diffChars(text1, text2);
                }

                renderDiff();
                resultBox.classList.remove('hidden');
                resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            } catch (e) {
                showToast('Error generating diff (check JSON syntax if using JSON mode).', 'error');
                console.error(e);
            }
        });

        // --- Rendering Logic ---

        function renderDiff() {
            diffTable.innerHTML = '';

            if (activeView === 'side') {
                renderSideBySide();
            } else {
                renderInline();
            }
        }

        // 1. Inline Render (Unified View)
        function renderInline() {
            let lineNumLeft = 1;
            let lineNumRight = 1;

            currentDiff.forEach(part => {
                const lines = part.value.split('\n');
                // Handle trailing newline artifact from split
                if (lines.length > 1 && lines[lines.length-1] === '') lines.pop();

                const typeClass = part.added ? 'diff-row-add' : (part.removed ? 'diff-row-del' : 'diff-row-neutral');
                
                lines.forEach(line => {
                    const tr = document.createElement('tr');
                    
                    // Left Num
                    const tdNumL = document.createElement('td');
                    tdNumL.className = 'diff-num';
                    tdNumL.textContent = part.added ? '' : lineNumLeft++;

                    // Right Num
                    const tdNumR = document.createElement('td');
                    tdNumR.className = 'diff-num';
                    tdNumR.textContent = part.removed ? '' : lineNumRight++;

                    // Code
                    const tdCode = document.createElement('td');
                    tdCode.className = `diff-code ${typeClass}`;
                    tdCode.textContent = line || ' '; // preserve empty lines

                    tr.appendChild(tdNumL);
                    tr.appendChild(tdNumR);
                    tr.appendChild(tdCode);
                    diffTable.appendChild(tr);
                });
            });
        }

        // 2. Side-by-Side Render (Split View)
        function renderSideBySide() {
            // Note: For Side-by-Side, 'diffLines' is usually best. 
            // If users selected 'chars' or 'words', splitting it side-by-side is tricky.
            // We will process the diff parts into line buckets.

            let rows = [];
            let leftBuffer = [];
            let rightBuffer = [];

            currentDiff.forEach(part => {
                const lines = part.value.split('\n');
                if (lines.length > 1 && lines[lines.length-1] === '') lines.pop();

                if (part.removed) {
                    leftBuffer.push(...lines);
                } else if (part.added) {
                    rightBuffer.push(...lines);
                } else {
                    // Neutral: Flush buffers first
                    flushBuffers(rows, leftBuffer, rightBuffer);
                    // Add neutral lines to both
                    lines.forEach(l => rows.push({ type: 'neutral', left: l, right: l }));
                }
            });
            
            // Flush remaining
            flushBuffers(rows, leftBuffer, rightBuffer);

            // Build HTML
            let lineL = 1;
            let lineR = 1;

            rows.forEach(row => {
                const tr = document.createElement('tr');

                // LEFT COLUMN
                const numL = document.createElement('td');
                numL.className = 'diff-num';
                const codeL = document.createElement('td');

                if (row.left !== null) {
                    numL.textContent = lineL++;
                    codeL.className = `diff-code ${row.type === 'change' || row.type === 'del' ? 'diff-row-del' : ''}`;
                    codeL.textContent = row.left || ' ';
                } else {
                    numL.textContent = '';
                    codeL.className = 'diff-code diff-empty';
                }

                // RIGHT COLUMN
                const numR = document.createElement('td');
                numR.className = 'diff-num';
                const codeR = document.createElement('td');

                if (row.right !== null) {
                    numR.textContent = lineR++;
                    codeR.className = `diff-code ${row.type === 'change' || row.type === 'add' ? 'diff-row-add' : ''}`;
                    codeR.textContent = row.right || ' ';
                } else {
                    numR.textContent = '';
                    codeR.className = 'diff-code diff-empty';
                }

                tr.appendChild(numL);
                tr.appendChild(codeL);
                tr.appendChild(numR);
                tr.appendChild(codeR);
                diffTable.appendChild(tr);
            });
        }

        // Helper to align added/removed blocks
        function flushBuffers(rows, leftBuf, rightBuf) {
            const max = Math.max(leftBuf.length, rightBuf.length);
            for (let i = 0; i < max; i++) {
                rows.push({
                    type: (leftBuf[i] !== undefined && rightBuf[i] !== undefined) ? 'change' : (leftBuf[i] !== undefined ? 'del' : 'add'),
                    left: leftBuf[i] !== undefined ? leftBuf[i] : null,
                    right: rightBuf[i] !== undefined ? rightBuf[i] : null
                });
            }
            // Clear arrays
            leftBuf.length = 0;
            rightBuf.length = 0;
        }

        // --- Actions ---
        clearBtn.addEventListener('click', () => {
            inputOriginal.value = '';
            inputChanged.value = '';
            resultBox.classList.add('hidden');
            diffTable.innerHTML = '';
        });
    </script>
</body>
</html>