<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diff Checker | Linus Linhof</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="icon" type="image/svg+xml" href="../../assets/favicon.svg">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>

    <style>
        /* Using project colors with opacity for readability */
        .diff-added {
            background-color: rgba(107, 144, 128, 0.25); /* --accent-secondary */
            color: var(--ink);
            border-bottom: 2px solid var(--accent-secondary);
            text-decoration: none;
        }
        .diff-removed {
            background-color: rgba(196, 77, 60, 0.15); /* --accent */
            color: var(--ink-secondary);
            text-decoration: line-through;
        }
        
        /* Dark mode adjustments for contrast */
        body.dark-mode .diff-added {
            background-color: rgba(107, 144, 128, 0.4);
            color: #fff;
        }
        body.dark-mode .diff-removed {
            background-color: rgba(196, 77, 60, 0.3);
            color: rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <main>
        <div class="container">
            <div class="tool-header">
                <h1>Diff Checker</h1>
                <p>Compare two blocks of text to highlight differences, additions, and deletions.</p>
            </div>

            <div class="card">
                
                <div class="split-view">
                    <div>
                        <label for="inputOriginal">Original Text</label>
                        <textarea id="inputOriginal" class="code-editor" placeholder="Paste original text here..."></textarea>
                    </div>
                    <div>
                        <label for="inputChanged">Modified Text</label>
                        <textarea id="inputChanged" class="code-editor" placeholder="Paste new text here..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 1.5rem; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex-grow: 1; min-width: 200px;">
                        <label for="diffMode">Comparison Mode</label>
                        <select id="diffMode" style="margin-bottom: 0;">
                            <option value="words" selected>Word by Word</option>
                            <option value="chars">Character by Character</option>
                            <option value="lines">Line by Line</option>
                            <option value="json">JSON (Semantic)</option>
                        </select>
                    </div>

                    <div style="padding-bottom: 5px;">
                        <label class="toggle-wrapper" style="margin-bottom: 0;">
                            <input type="checkbox" id="ignoreWhitespace" class="toggle-checkbox">
                            <div class="toggle-switch"></div>
                            <span style="font-size: 0.9rem;">Ignore Whitespace</span>
                        </label>
                    </div>
                    
                    <div class="button-group" style="margin-top: 0;">
                        <button class="button" id="compareBtn">Compare Text</button>
                        <button class="button outline" id="clearBtn">Clear All</button>
                    </div>
                </div>

                <div class="result-box hidden" id="resultBox">
                    <label>Comparison Result</label>
                    <div id="diffOutput" class="code-view" style="min-height: 100px;"></div>
                    
                    <div class="button-group" style="margin-top: 1rem;">
                        <button class="button sm secondary" onclick="copyResult()">Copy Output Text</button>
                    </div>
                </div>

            </div>
        </div>
    </main>
    
    <script src="../../assets/js/layout.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const originalInput = document.getElementById('inputOriginal');
            const changedInput = document.getElementById('inputChanged');
            const compareBtn = document.getElementById('compareBtn');
            const clearBtn = document.getElementById('clearBtn');
            const diffMode = document.getElementById('diffMode');
            const ignoreWhitespace = document.getElementById('ignoreWhitespace');
            const resultBox = document.getElementById('resultBox');
            const diffOutput = document.getElementById('diffOutput');

            // Compare Action
            compareBtn.addEventListener('click', () => {
                const text1 = originalInput.value;
                const text2 = changedInput.value;
                const mode = diffMode.value;
                const ignoreSpace = ignoreWhitespace.checked;

                if (!text1 && !text2) {
                    showToast('Please enter text to compare.', 'error');
                    return;
                }

                try {
                    let diff;
                    
                    // 1. Handle JSON specifically to format it before diffing
                    if (mode === 'json') {
                        try {
                            // Parse and re-stringify to ensure formatting is identical
                            // This effectively ignores whitespace automatically
                            const json1 = text1 ? JSON.stringify(JSON.parse(text1), null, 2) : '';
                            const json2 = text2 ? JSON.stringify(JSON.parse(text2), null, 2) : '';
                            diff = Diff.diffJson(JSON.parse(text1 || '{}'), JSON.parse(text2 || '{}'));
                        } catch (e) {
                            showToast('Invalid JSON data detected.', 'error');
                            return;
                        }
                    } 
                    // 2. Line Mode
                    else if (mode === 'lines') {
                        if (ignoreSpace) {
                            // diffTrimmedLines ignores leading/trailing whitespace per line
                            diff = Diff.diffTrimmedLines(text1, text2);
                        } else {
                            diff = Diff.diffLines(text1, text2);
                        }
                    }
                    // 3. Word Mode
                    else if (mode === 'words') {
                        if (ignoreSpace) {
                            // diffWords ignores whitespace differences (treats whitespace as insignificant)
                            diff = Diff.diffWords(text1, text2);
                        } else {
                            // diffWordsWithSpace treats whitespace as significant
                            diff = Diff.diffWordsWithSpace(text1, text2);
                        }
                    }
                    // 4. Char Mode
                    else {
                        diff = Diff.diffChars(text1, text2);
                    }

                    renderDiff(diff);
                    resultBox.classList.remove('hidden');
                    
                    // Scroll to result
                    resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    showToast('Comparison complete', 'success');

                } catch (err) {
                    console.error(err);
                    showToast('An error occurred during comparison.', 'error');
                }
            });

            // Render Logic
            function renderDiff(diff) {
                const fragment = document.createDocumentFragment();

                diff.forEach((part) => {
                    // Determine class based on status
                    const span = document.createElement('span');
                    
                    if (part.added) {
                        span.className = 'diff-added';
                    } else if (part.removed) {
                        span.className = 'diff-removed';
                    }
                    
                    span.textContent = part.value;
                    fragment.appendChild(span);
                });

                diffOutput.innerHTML = '';
                diffOutput.appendChild(fragment);
            }

            // Clear Action
            clearBtn.addEventListener('click', () => {
                originalInput.value = '';
                changedInput.value = '';
                resultBox.classList.add('hidden');
                diffOutput.innerHTML = '';
                showToast('Inputs cleared', 'info');
            });
        });

        // Copy Helper
        function copyResult() {
            const content = document.getElementById('diffOutput').innerText;
            copyToClipboard(content);
        }
    </script>
</body>
</html>